import React, { useEffect, useState } from "react";

// Drone Monitor Dashboard // - Uses Open-Meteo (no API key) for weather & air quality // - Uses NOAA SWPC for planetary K-index (geomagnetic activity) // - Replace endpoints or add API keys if you prefer other providers

export default function DroneMonitorDashboard() { const [lat, setLat] = useState(37.5665); // default: Seoul const [lon, setLon] = useState(126.9780); const [weather, setWeather] = useState(null); const [air, setAir] = useState(null); const [kIndex, setKIndex] = useState(null); const [loading, setLoading] = useState(false); const [error, setError] = useState(null); const [lastUpdated, setLastUpdated] = useState(null);

// Safety thresholds (editable) const thresholds = { windSafe: 8, // m/s — above this is risky for most consumer drones pm25Safe: 35, // µg/m3 — above this is unhealthy for sensitive groups kIndexSafe: 4, // K-index >4 indicates geomagnetic storm conditions };

useEffect(() => { fetchAll(); // refresh every 5 minutes const id = setInterval(fetchAll, 5 * 60 * 1000); return () => clearInterval(id); // eslint-disable-next-line react-hooks/exhaustive-deps }, [lat, lon]);

async function fetchAll() { setLoading(true); setError(null); try { await Promise.all([fetchWeather(), fetchAir(), fetchKIndex()]); setLastUpdated(new Date().toISOString()); } catch (e) { setError(e.message || String(e)); } finally { setLoading(false); } }

async function fetchWeather() { // Open-Meteo: current_weather + hourly forecast const url = https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,windspeed_10m,winddirection_10m&timezone=auto; const res = await fetch(url); if (!res.ok) throw new Error("Weather fetch failed"); const data = await res.json(); setWeather(data); }

async function fetchAir() { // Open-Meteo Air Quality API (public, no key) const url = https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm10,pm2_5; const res = await fetch(url); if (!res.ok) throw new Error("Air quality fetch failed"); const data = await res.json(); setAir(data); }

async function fetchKIndex() { // NOAA SWPC planetary K-index JSON (no API key) // This endpoint returns an array of arrays; last entry usually newest const url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json"; const res = await fetch(url); if (!res.ok) throw new Error("K-index fetch failed"); const data = await res.json(); // data is an array where each item is like ["YYYY-MM-DDTHH:MM:SSZ", kindex] // pick the last non-empty K value const last = data.slice().reverse().find((row) => row && row.length >= 2 && row[1] !== null && row[1] !== ""); if (!last) throw new Error("No K-index data available"); setKIndex({ time: last[0], value: Number(last[1]) }); }

function getWind() { if (!weather) return null; // If current_weather exists if (weather.current_weather && weather.current_weather.windspeed != null) return weather.current_weather.windspeed; // fallback to hourly return weather.hourly && weather.hourly.windspeed_10m ? weather.hourly.windspeed_10m[0] : null; }

function getTemp() { if (!weather) return null; if (weather.current_weather && weather.current_weather.temperature != null) return weather.current_weather.temperature; return weather.hourly && weather.hourly.temperature_2m ? weather.hourly.temperature_2m[0] : null; }

function getPM25() { if (!air) return null; // hourly.pm2_5 is an array aligned with hourly.time — pick last if (!air.hourly || !air.hourly.pm2_5 || !air.hourly.time) return null; const lastIdx = air.hourly.pm2_5.length - 1; return air.hourly.pm2_5[lastIdx]; }

const wind = getWind(); const temp = getTemp(); const pm25 = getPM25();

function statusClass(condition) { if (condition === "ok") return "bg-green-100 text-green-800"; if (condition === "warn") return "bg-yellow-100 text-yellow-800"; if (condition === "danger") return "bg-red-100 text-red-800"; return "bg-gray-100 text-gray-800"; }

function evaluateStatus() { const problems = []; if (wind != null && wind > thresholds.windSafe) problems.push(강한 바람: ${wind} m/s); if (pm25 != null && pm25 > thresholds.pm25Safe) problems.push(미세먼지 높음(PM2.5): ${pm25} µg/m³); if (kIndex && kIndex.value > thresholds.kIndexSafe) problems.push(자기장 활동 높음: K=${kIndex.value}); return problems; }

const problems = evaluateStatus(); const overall = problems.length === 0 ? "ok" : problems.some(p => p.includes('강한 바람') || p.includes('자기장')) ? "danger" : "warn";

return ( <div className="min-h-screen p-6 bg-gray-50"> <div className="max-w-4xl mx-auto"> <header className="mb-6"> <h1 className="text-2xl font-bold">드론 비행 모니터 대시보드</h1> <p className="text-sm text-gray-600">위치(위도/경도)를 입력하면 날씨, 풍속, 미세먼지, 자기장 지수를 조회합니다.</p> </header>

<section className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div className="col-span-2 p-4 bg-white rounded-2xl shadow">
        <label className="block text-sm font-medium text-gray-700">위도 (latitude)</label>
        <input value={lat} onChange={(e) => setLat(parseFloat(e.target.value) || 0)} className="mt-1 p-2 border rounded w-full" />
        <label className="block text-sm font-medium text-gray-700 mt-3">경도 (longitude)</label>
        <input value={lon} onChange={(e) => setLon(parseFloat(e.target.value) || 0)} className="mt-1 p-2 border rounded w-full" />

        <div className="mt-4 flex gap-2">
          <button onClick={fetchAll} className="px-3 py-2 rounded bg-blue-600 text-white">지금 조회</button>
          <button onClick={() => { setLat(37.5665); setLon(126.9780); }} className="px-3 py-2 rounded border">서울로 초기화</button>
          <div className="ml-auto text-sm text-gray-500">업데이트: {lastUpdated ? new Date(lastUpdated).toLocaleString() : '—'}</div>
        </div>
      </div>

      <div className={`p-4 rounded-2xl shadow ${statusClass(overall)}`}>
        <h3 className="font-semibold">종합 권장 상태</h3>
        <p className="mt-2 text-sm">
          {overall === 'ok' && '지금은 대체로 안전해 보입니다. (기본 권장 기준)'}
          {overall === 'warn' && '주의: 일부 지표가 경고 수준입니다. 상황을 확인하세요.'}
          {overall === 'danger' && '위험: 하나 이상의 지표가 위험 범위에 있습니다. 비행을 삼가세요.'}
        </p>
        {problems.length > 0 && (
          <ul className="mt-2 text-sm list-disc list-inside">
            {problems.map((p, i) => <li key={i}>{p}</li>)}
          </ul>
        )}
      </div>
    </section>

    <section className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div className="p-4 bg-white rounded-2xl shadow">
        <h4 className="font-medium">기온</h4>
        <div className="mt-3 text-3xl">{temp != null ? `${temp}°C` : '—'}</div>
        <div className="text-sm text-gray-500 mt-2">Open-Meteo</div>
      </div>

      <div className="p-4 bg-white rounded-2xl shadow">
        <h4 className="font-medium">풍속</h4>
        <div className="mt-3 text-3xl">{wind != null ? `${wind} m/s` : '—'}</div>
        <div className="text-sm text-gray-500 mt-2">권장 안전 기준: {thresholds.windSafe} m/s 이하</div>
      </div>

      <div className="p-4 bg-white rounded-2xl shadow">
        <h4 className="font-medium">미세먼지 (PM2.5)</h4>
        <div className="mt-3 text-3xl">{pm25 != null ? `${pm25} µg/m³` : '—'}</div>
        <div className="text-sm text-gray-500 mt-2">권장 기준: {thresholds.pm25Safe} µg/m³ 이하</div>
      </div>
    </section>

    <section className="mt-4 p-4 bg-white rounded-2xl shadow">
      <h4 className="font-medium">자기장 지수 (K-index)</h4>
      <div className="mt-2 text-2xl">{kIndex ? `K = ${kIndex.value}` : '—'}</div>
      <div className="text-sm text-gray-500 mt-2">데이터 출처: NOAA SWPC</div>
      {kIndex && <div className="text-sm text-gray-600 mt-2">측정시각: {new Date(kIndex.time).toLocaleString()}</div>}
    </section>

    <footer className="mt-6 text-xs text-gray-500">
      <p>참고: 이 대시보드는 참고용입니다. 실제 비행 결정은 제조사 권고, 현장 상황, 법규(관제/비행금지구역) 등을 반드시 확인하세요.</p>
      <p className="mt-1">원하는 추가 기능: 비행 금지구역 표시, 경로 시뮬레이션, SMS/알림 연동 등은 요청해 주세요.</p>
    </footer>

    {loading && <div className="fixed right-4 bottom-4 p-3 bg-white rounded shadow text-sm">데이터를 불러오는 중…</div>}
    {error && <div className="fixed left-4 bottom-4 p-3 bg-red-100 text-red-800 rounded shadow text-sm">에러: {error}</div>}
  </div>
</div>

); }

